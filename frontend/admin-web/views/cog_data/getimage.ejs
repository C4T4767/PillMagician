<script>

  let table;
  let data;
  function detail(itemSeq, type) {
    window.location.href = `/data/getimage_detail/${itemSeq}?type=${type}`;
  }
  
  function addFolder() {
    const folderName = prompt("추가할 폴더 이름을 입력하세요:");
    const type = prompt("폴더 타입을 입력하세요 (test/train/val):");
    if (folderName && type) {
      $.ajax({
        url: '/data/getimage_folder',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ folderName, type }),
        success: function(response) {
          alert(response);
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('폴더 추가 오류: ' + xhr.responseText);
        }
      });
    }
  }
  
  function deleteFolder(folderName, type) {
    if (confirm(`${folderName} 폴더를 삭제하시겠습니까?`)) {
      $.ajax({
        url: '/data/getimage_folder',
        type: 'DELETE',
        contentType: 'application/json',
        data: JSON.stringify({ folderName, type }),
        success: function(response) {
          alert(response);
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('폴더 삭제 오류: ' + xhr.responseText);
        }
      });
    }
  }
  
  // 데이터 테이블
  window.addEventListener('DOMContentLoaded', event => {
    $('#loadingModal').modal('show');
  
    const datatablesSimple = document.getElementById('datatablesSimple');
    if (datatablesSimple) {
      table = new simpleDatatables.DataTable(datatablesSimple, {
        processing: true,
        serverSide: true,
        searching: true,
        ordering: false,
        serverMethod: 'POST',
        ajax: {
          url: '/data/getimage_data_set',
          type: 'POST',
          dataSrc: 'type',
        },
        columns: [
          { data: 'item_seq' }, // 첫 번째 열
          { data: 'item_name' }, // 두 번째 열
          { data: 'entp_name' }, // 세 번째 열
          { data: 'drug_shape' }, // 네 번째 열
          { data: 'class_name' }, // 다섯 번째 열
          { data: 'class_name' }, // 여섯 번째 열
          { data: 'detail' }
        ]
      });
  
      // 데이터 로딩 함수
      function loadData() {
        console.log("asd");
        // 추가 데이터를 비동기적으로 로드합니다.
        $.ajax({
          url: '/data/getimage_data_set',
          type: 'POST',
          success: function(data) {
            console.log("굿");
            // 성공적으로 데이터를 받았을 때 처리
            data = data;
            renderTable(data); // 데이터가 로드된 후에 테이블 렌더링
            // 데이터 로딩이 완료되면 모달을 숨깁니다.
            $('#loadingModal').modal('hide');
          },
          error: function(xhr, status, error) {
            console.log("뻑");
            // 오류 처리
            console.error('데이터 로드 오류:', error);
            // 오류가 발생했을 때도 모달을 숨깁니다.
            $('#loadingModal').modal('hide');
          }
        });
      }
  
      // 데이터를 테이블에 렌더링하는 함수
      function renderTable(data) {
        console.log(data);
        let total = [];
        data.test.forEach(function(a) {
          let da = [
            a.folderName,
            'test',
            a.data[0].item_name,
            a.subfolderCount,
            `<button class="btn btn-primary btn-sm" style="font-size: 12px;" onclick="detail(${a.data[0].item_seq}, 'test')">detail</button>`,
            `<button class="btn btn-secondary btn-sm" style="font-size: 12px;" onclick="deleteFolder('${a.folderName}', 'test')">Delete</button>`
          ];
          total.push(da);
        });
        data.train.forEach(function(a) {
          let da = [
            a.folderName,
            'train',
            a.data[0].item_name,
            a.subfolderCount,
            `<button class="btn btn-primary btn-sm" style="font-size: 12px;" onclick="detail(${a.data[0].item_seq}, 'train')">detail</button>`,
            `<button class="btn btn-secondary btn-sm" style="font-size: 12px;" onclick="deleteFolder('${a.folderName}', 'train')">Delete</button>`
          ];
          total.push(da);
        });
        data.val.forEach(function(a) {
          let da = [
            a.folderName,
            'val',
            a.data[0].item_name,
            a.subfolderCount,
            `<button class="btn btn-primary btn-sm" style="font-size: 12px;" onclick="detail(${a.data[0].item_seq}, 'val')">detail</button>`,
            `<button class="btn btn-secondary btn-sm" style="font-size: 12px;" onclick="deleteFolder('${a.folderName}', 'val')">Delete</button>`
          ];
          total.push(da);
        });
  
        table.insert({ data: total });
        console.log("완료");
      }
  
      // 데이터 로딩
      loadData();
    }
  });
  
  </script>
  
  <!-- 모달 -->
  <div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content bg-dark">
        <div class="modal-body text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-light mt-2">Loading...</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container-fluid px-4">
    <h1 class="mt-4">알약 이미지 데이터 관리</h1>
    <hr>
  </div>
  
  <style>
    /* 테이블 칼럼 가운데 정렬 */
    #datatablesSimple th:nth-child(n+1) {
      text-align: center;
    }
  
    /* 이름 부분의 너비 조정 */
    #datatablesSimple th:nth-child(2) {
      width: 100px; /* 원하는 너비로 조정하세요 */
      overflow: hidden;
      text-overflow: ellipsis; /* 너무 긴 텍스트를 ...으로 줄여줍니다 */
    }
  </style>
  
  <div class="container-fluid px-4">
    <div class="card mb-4">
      <div class="card-body">
        모델 학습에서 사용하는 이미지 데이터를 관리할 수 있다. <br> 폴더를 추가할 때에는 데이터베이스에 있는 알약 식별 코드로 생성해야합니다.
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-header">
        <i class="fas fa-table me-1"></i>
        알약 이미지 데이터
      </div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-success" onclick="addFolder()">폴더 추가</button>
        </div>
        <table id="datatablesSimple">
          <thead>
            <tr>
              <th>ID</th>
              <th>폴더 위치</th>
              <th>알약 이름</th>
              <th>이미지 개수</th>
              <th>세부정보</th>
              <th>폴더 삭제</th>
            </tr>
          </thead>
          <tbody id="datasimplebody">
            
          </tbody>
        </table>
      </div>
    </div>
  </div>
  