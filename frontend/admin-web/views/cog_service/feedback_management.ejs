<script>
  let table;
  let feedback;

  function detail(a) {
      window.location.href = '/service/feedback_detail/' + a;
  }

  // 데이터 테이블
  window.addEventListener('DOMContentLoaded', event => {
      $('#loadingModal').modal('show');

      const datatablesSimple = document.getElementById('datatablesSimple');
      if (datatablesSimple) {
          table = new simpleDatatables.DataTable(datatablesSimple, {
              processing: true,
              serverSide: true,
              searching: true,
              ordering: false,
              serverMethod: 'POST',
              ajax: {
                  url: '/service/feedback',
                  type: 'POST',
                  dataSrc: 'feedbacks'
              },
              columns: [
                  { data: 'feedback_num' }, // 첫 번째 열
                  { data: 'user_num' }, // 두 번째 열
                  { data: 'title' }, // 세 번째 열
                  { data: 'contents' }, // 네 번째 열
                  { data: 'rating' }, // 다섯 번째 열
                  {
                      data: null, // 여섯 번째 열 (세부정보 버튼)
                      render: function (data, type, row) {
                          return `<button class="btn btn-primary btn-sm" style="font-size: 12px;" onclick="detail(${row.feedback_num})">detail</button>`;
                      }
                  }
              ]
          });

          // 데이터 로딩 함수
          function loadData() {
              // 추가 데이터를 비동기적으로 로드합니다.
              $.ajax({
                  url: '/service/feedback',
                  type: 'POST',
                  success: function (data) {
                      console.log("굿");
                      // 성공적으로 데이터를 받았을 때 처리
                      feedback = data.feedbacks;
                      renderTable(); // 데이터가 로드된 후에 테이블 렌더링
                      // 데이터 로딩이 완료되면 모달을 숨깁니다.
                      $('#loadingModal').modal('hide');
                  },
                  error: function (xhr, status, error) {
                      console.log("뻑");
                      // 오류 처리
                      console.error('데이터 로드 오류:', error);
                      // 오류가 발생했을 때도 모달을 숨깁니다.
                      $('#loadingModal').modal('hide');
                  }
              });
          }

          // 데이터를 테이블에 렌더링하는 함수
          function renderTable() {
              console.log(feedback);
              let total = [];
              feedback.forEach(function (a) {
                  let da = [a.feedback_num, a.user_num, a.title, a.contents, a.rating, `<button class="btn btn-primary btn-sm" style="font-size: 12px;" onclick="detail(${a.feedback_num})">detail</button>`];
                  total.push(da);
              });
              table.insert({ data: total });
              console.log("완료");
          }

          // 데이터 로딩
          loadData();
      }
  });
</script>

<!-- 모달 -->
<div class="modal" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content bg-dark">
          <div class="modal-body text-center">
              <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-light mt-2">Loading...</p>
          </div>
      </div>
  </div>
</div>

<div class="container-fluid px-4">
  <h1 class="mt-4">유저 피드백 관리</h1>
  <hr>
</div>

<div class="container-fluid px-4">
  <div class="card mb-4">
      <div class="card-body">
          현재 서비스를 이용중인 고객들이 보낸 피드백을 확인 및 관리할 수 있다.
      </div>
  </div>
  <div class="card mb-4">
      <div class="card-header">
          <i class="fas fa-table me-1"></i>
          피드백 데이터
      </div>
      <div class="card-body">
          <table id="datatablesSimple">
              <thead>
                  <tr>
                      <th>index</th>
                      <th>사용자 번호</th>
                      <th>title</th>
                      <th>contents</th>
                      <th>rating</th>
                      <th>세부정보</th>
                  </tr>
              </thead>
              <tbody id="datasimplebody">

              </tbody>
          </table>
      </div>
  </div>
</div>
